<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SEM Image Analysis</title>
  <style>
    :root{
      --bg:#ffffff; --panel:#ffffff; --text:#111111; --muted:#6b7280;
      --border:#e5e7eb; --shadow:0 10px 30px rgba(0,0,0,0.06);
      --btn:#111111; --btnText:#ffffff;
      --pillBg:#f3f4f6;
      --inputBg:#ffffff;
      --contentMax: 980px;
    }
    [data-theme="dark"]{
      --bg:#0b0f19; --panel:#0f1629; --text:#e5e7eb; --muted:#9ca3af;
      --border:rgba(255,255,255,0.10); --shadow:0 10px 30px rgba(0,0,0,0.35);
      --btn:#e5e7eb; --btnText:#0b0f19;
      --pillBg:rgba(255,255,255,0.08);
      --inputBg:rgba(255,255,255,0.06);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:28px 18px; }
    .shell{ width:100%; max-width:var(--contentMax); display:flex; flex-direction:column; gap:14px; }

    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand img{ width:34px; height:34px; border-radius:10px; border:1px solid var(--border); background:var(--panel); object-fit:contain; padding:4px; }
    .title{ font-size:14px; font-weight:650; letter-spacing:0.2px; }
    .subtitle{ font-size:12px; color:var(--muted); margin-top:2px; line-height:1.35; }
    .toggleBtn{ border:1px solid var(--border); background:var(--panel); color:var(--text);
      border-radius:12px; padding:8px 10px; cursor:pointer; box-shadow:var(--shadow); font-weight:600; }

    .panel{ border:1px solid var(--border); background:var(--panel); border-radius:18px; box-shadow:var(--shadow); padding:16px; }
    .centerHero{ display:flex; flex-direction:column; align-items:center; text-align:center; gap:10px; padding:6px 0 2px 0; }
    .heroLogo{ width:64px; height:64px; border-radius:18px; border:1px solid var(--border); background:var(--panel);
      object-fit:contain; padding:6px; box-shadow:var(--shadow); }
    .heroH{ font-size:20px; font-weight:800; margin:0; letter-spacing:0.2px; }
    .heroP{ font-size:13px; color:var(--muted); margin:0; max-width:820px; line-height:1.5; }

    .metaRow{ display:flex; align-items:center; justify-content:center; gap:10px; margin-top:6px; flex-wrap:wrap; }
    .btn{ border:0; background:var(--btn); color:var(--btnText); padding:10px 14px; border-radius:14px; cursor:pointer; font-weight:750; }
    .btn.secondary{ border:1px solid var(--border); background:var(--panel); color:var(--text); box-shadow:var(--shadow); font-weight:700; }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px; align-items:start; }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }

    .drop{ border:2px dashed var(--border); border-radius:16px; padding:18px; min-height:200px; display:flex; align-items:center; justify-content:center;
      text-align:center; color:var(--muted); background:var(--inputBg); cursor:pointer; transition:120ms; }
    .drop.dragover{ border-color:var(--btn); color:var(--text); transform:translateY(-1px); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; margin-top:10px; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
    input[type="number"]{ border:1px solid var(--border); border-radius:12px; padding:10px 10px; width:160px; background:var(--inputBg); color:var(--text); outline:none; }

    .nmWrap{ display:flex; gap:8px; align-items:end; }
    .btnSmall{ border:1px solid var(--border); background:var(--panel); color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; box-shadow:var(--shadow); font-weight:700; }
    .btnSmall:disabled{ opacity:0.5; cursor:not-allowed; box-shadow:none; }

    .chk{ display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:var(--inputBg); }
    .status{ font-size:12px; color:var(--muted); margin-top:10px; min-height:18px; }

    .preview img{ width:100%; border-radius:14px; border:1px solid var(--border); background:var(--panel); display:block; }
    .card{ border:1px solid var(--border); border-radius:16px; background:var(--inputBg); padding:12px; }
    .cards{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    @media (max-width:540px){ .cards{ grid-template-columns:1fr; } }
    .kv{ display:flex; justify-content:space-between; gap:10px; font-size:13px; line-height:1.6; }
    .kv span:first-child{ color:var(--muted); }

    details{ margin-top:10px; border-radius:16px; border:1px solid var(--border); background:var(--panel); padding:10px 12px; }
    summary{ cursor:pointer; color:var(--muted); font-size:12px; font-weight:650; user-select:none; }
    pre{ margin:10px 0 0 0; padding:12px; border:1px solid var(--border); border-radius:14px; background:rgba(127,127,127,0.10);
      overflow:auto; font-size:12px; line-height:1.45; white-space:pre-wrap; }

    .foot{ text-align:center; color:var(--muted); font-size:12px; padding-top:2px; }

    /* slider */
    input[type="range"]{ width: 260px; accent-color: var(--btn); }
  </style>
</head>
<body>
<div class="wrap">
  <div class="shell">

    <div class="topbar">
      <div class="brand">
        <img id="logoTop" src="/static/logo_day.png" onerror="this.style.display='none';" alt="DLR logo"/>
        <div>
          <div class="title">SEM Image Analysis</div>
          <div class="subtitle">Enter startet Analyze · Porosity + Length automatisch · Threshold per Slider</div>
        </div>
      </div>
      <button class="toggleBtn" id="themeBtn" onclick="toggleTheme()">Dark mode</button>
    </div>

    <div class="panel">
      <div class="centerHero">
        <img id="logoHero" class="heroLogo" src="/static/logo_day.png" onerror="this.style.display='none';" alt="DLR logo"/>
        <div class="heroH">Analyze SEM images locally</div>
        <p class="heroP">
          Tool berechnet <b>Porosity (2D-Flächenanteil)</b> und <b>Längenstatistik</b>.
          SEM-Legende/Scale wird automatisch ausgeschlossen.
        </p>

        <div class="metaRow">
          <button class="btn secondary" onclick="clearAll()">Clear</button>
        </div>
      </div>

      <div class="grid">
        <!-- Left -->
        <div>
          <div id="drop" class="drop" title="Drop image here or click to select.">
            <div>
              <div style="font-weight:800; color: var(--text);">Bild hier ablegen</div>
              <div style="margin-top:6px;">oder klicken zum Auswählen</div>
              <div style="margin-top:10px;font-size:12px;">PNG/JPG (TIFF je nach OpenCV)</div>
            </div>
          </div>
          <input id="file" type="file" accept="image/*" style="display:none"/>

          <div class="row">
            <div>
              <label>nm/px (optional)</label>
              <div class="nmWrap">
                <input id="nm_per_px" type="number" step="0.0001" placeholder="z.B. 2.5"/>
                <button class="btnSmall" id="autoScaleBtn" onclick="autoScale()" disabled>Auto</button>
              </div>
            </div>

            <div>
              <label>min area (px)</label>
              <input id="min_area_px" type="number" step="1" value="80"/>
            </div>

            <div>
              <label>hole area (px)</label>
              <input id="hole_area_px" type="number" step="1" value="0"/>
            </div>

            <div class="chk">
              <input id="invert" type="checkbox"/>
              <label for="invert" style="margin:0;">invert (foreground hell)</label>
            </div>
          </div>

          <!-- ✅ NEW: Threshold slider -->
          <div class="row" style="margin-top:12px;">
            <div>
              <label>Threshold (Otsu-Offset)</label>
              <input id="thr_offset" type="range" min="-80" max="80" step="1" value="0">
              <div style="font-size:12px;color:var(--muted);margin-top:4px;">
                Offset: <span id="thr_offset_val">0</span>
              </div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px;max-width:520px;">
                Hinweis: größerer Offset ⇒ mehr Pixel werden als „Foreground“ (dunkel) klassifiziert (ohne invert).
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="analyzeBtn" onclick="analyze()">Analyze</button>
          </div>

          <div class="status" id="status"></div>

          <div id="scaleBox" style="display:none; margin-top:10px;">
            <details open>
              <summary>Auto-Scale Result (compact)</summary>
              <pre id="scaleOut"></pre>
              <div id="scalePreviewWrap" style="margin-top:10px; display:none;">
                <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">Detection preview</div>
                <img id="scalePreview" alt="scale preview" style="width:100%;border-radius:14px;border:1px solid var(--border);"/>
              </div>
            </details>
          </div>
        </div>

        <!-- Right -->
        <div class="preview">
          <div class="card" id="fileCard" style="display:none;">
            <div class="kv"><span>File</span><span id="fileName"></span></div>
            <div class="kv"><span>Resize factor</span><span id="resizeFactor">-</span></div>
            <div class="kv"><span>Effective nm/px</span><span id="effScale">-</span></div>
            <div class="kv"><span>Threshold used</span><span id="thrUsed">-</span></div>
          </div>

          <div class="cards" id="metricsCards" style="display:none;">
            <div class="card" id="cardArea">
              <div style="font-weight:750; margin-bottom:6px;">Area fractions</div>
              <div class="kv"><span>Foreground</span><span id="mFg">-</span></div>
              <div class="kv"><span>Background</span><span id="mBg">-</span></div>
            </div>
            <div class="card" id="cardLen">
              <div style="font-weight:750; margin-bottom:6px;">Lengths</div>
              <div class="kv"><span>N objects</span><span id="mN">-</span></div>
              <div class="kv"><span>Mean (px)</span><span id="mMeanPx">-</span></div>
              <div class="kv"><span>Median (px)</span><span id="mMedPx">-</span></div>
              <div class="kv"><span>Mean (µm)</span><span id="mMeanUm">-</span></div>
            </div>
          </div>

          <div id="overlayBox" style="display:none;">
            <div style="font-size:12px;color:var(--muted);margin:4px 0;">Overlay (Maske rot, Exclusion blau)</div>
            <img id="overlayImg" alt="overlay"/>
          </div>

          <div id="maskBox" style="display:none;">
            <div style="font-size:12px;color:var(--muted);margin:10px 0 4px 0;">Maske (Legend ausgeschlossen)</div>
            <img id="maskImg" alt="mask"/>
          </div>

          <details id="jsonDetails" style="display:none;">
            <summary>Result JSON (data-only)</summary>
            <pre id="out">{}</pre>
          </details>
        </div>
      </div>
    </div>

    <div class="foot">Local-only. Porosity = 2D-Flächenanteil aus Maske.</div>

  </div>
</div>

<script>
let selectedFile = null;

function setStatus(s){ document.getElementById("status").textContent = s || ""; }

function setLogoForTheme(t){
  const src = (t === "dark") ? "/static/logo_night.png" : "/static/logo_day.png";
  const top = document.getElementById("logoTop");
  const hero = document.getElementById("logoHero");
  if(top) top.src = src;
  if(hero) hero.src = src;
}

function applyTheme(t){
  document.documentElement.setAttribute("data-theme", t);
  localStorage.setItem("theme", t);
  const btn = document.getElementById("themeBtn");
  if(btn) btn.textContent = (t === "dark") ? "Light mode" : "Dark mode";
  setLogoForTheme(t);
}

function toggleTheme(){
  const cur = localStorage.getItem("theme");
  applyTheme(cur === "dark" ? "light" : "dark");
}

(function initTheme(){
  const saved = localStorage.getItem("theme");
  if(saved){ applyTheme(saved); }
  else{
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    applyTheme(prefersDark ? "dark" : "light");
  }
})();

// slider live value
const thrSlider = document.getElementById("thr_offset");
const thrVal = document.getElementById("thr_offset_val");
thrVal.textContent = thrSlider.value;
thrSlider.addEventListener("input", () => { thrVal.textContent = thrSlider.value; });

function clearAll(){
  selectedFile = null;
  document.getElementById("file").value = "";
  document.getElementById("autoScaleBtn").disabled = true;

  document.getElementById("fileCard").style.display = "none";
  document.getElementById("metricsCards").style.display = "none";
  document.getElementById("overlayBox").style.display = "none";
  document.getElementById("maskBox").style.display = "none";
  document.getElementById("jsonDetails").style.display = "none";

  document.getElementById("scaleBox").style.display = "none";
  document.getElementById("scaleOut").textContent = "";
  document.getElementById("scalePreviewWrap").style.display = "none";
  document.getElementById("scalePreview").src = "";

  document.getElementById("out").textContent = "{}";
  setStatus("");
}

const drop = document.getElementById("drop");
const fileInput = document.getElementById("file");

drop.addEventListener("click", () => fileInput.click());
fileInput.addEventListener("change", (e) => {
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  selectedFile = f;
  document.getElementById("fileName").textContent = f.name;
  document.getElementById("fileCard").style.display = "block";
  document.getElementById("autoScaleBtn").disabled = false;
  setStatus("File selected: " + f.name);
});

drop.addEventListener("dragover", (e) => { e.preventDefault(); drop.classList.add("dragover"); });
drop.addEventListener("dragleave", () => drop.classList.remove("dragover"));
drop.addEventListener("drop", (e) => {
  e.preventDefault();
  drop.classList.remove("dragover");
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(!f) return;
  selectedFile = f;
  document.getElementById("fileName").textContent = f.name;
  document.getElementById("fileCard").style.display = "block";
  document.getElementById("autoScaleBtn").disabled = false;
  setStatus("File dropped: " + f.name);
});

function fmt(x){
  if(x === null || x === undefined) return "-";
  if(typeof x === "number") return x.toFixed(4);
  return String(x);
}

// Enter -> Analyze (global), only if file selected
document.addEventListener("keydown", (e) => {
  if(e.key === "Enter"){
    if(e.shiftKey || e.ctrlKey || e.metaKey || e.altKey) return;
    if(!selectedFile) return;
    e.preventDefault();
    analyze();
  }
});

async function autoScale(){
  if(!selectedFile){ setStatus("Bitte zuerst ein Bild auswählen."); return; }

  setStatus("Auto-Scale: suche Scale-Bar…");
  document.getElementById("scaleBox").style.display = "none";
  document.getElementById("scaleOut").textContent = "";
  document.getElementById("scalePreviewWrap").style.display = "none";
  document.getElementById("scalePreview").src = "";

  const fd = new FormData();
  fd.append("file", selectedFile);

  try{
    const res = await fetch("/api/sem/detect_scale", { method:"POST", body: fd });
    const j = await res.json();

    document.getElementById("scaleBox").style.display = "block";

    const compact = {...j};
    if(compact.preview_png_b64) delete compact.preview_png_b64;
    document.getElementById("scaleOut").textContent = JSON.stringify(compact, null, 2);

    if(j.preview_png_b64){
      document.getElementById("scalePreviewWrap").style.display = "block";
      document.getElementById("scalePreview").src = "data:image/png;base64," + j.preview_png_b64;
    }

    if(j.ok && j.nm_per_px){
      document.getElementById("nm_per_px").value = Number(j.nm_per_px).toFixed(6);
      setStatus(`Auto-Scale ok: ${j.scale_label} / ${j.bar_length_px}px → ${Number(j.nm_per_px).toFixed(6)} nm/px`);
    }else{
      setStatus("Auto-Scale nicht erfolgreich (siehe Details).");
    }
  }catch(e){
    setStatus("Auto-Scale error: " + e);
  }
}

async function analyze(){
  if(!selectedFile){ setStatus("Bitte zuerst ein Bild auswählen."); return; }
  setStatus("Analysiere…");

  const nm_per_px = document.getElementById("nm_per_px").value;
  const invert = document.getElementById("invert").checked ? "1" : "0";
  const min_area_px = document.getElementById("min_area_px").value || "80";
  const hole_area_px = document.getElementById("hole_area_px").value || "0";
  const thr_offset = document.getElementById("thr_offset").value || "0";

  const fd = new FormData();
  fd.append("file", selectedFile);
  fd.append("invert", invert);
  fd.append("min_area_px", min_area_px);
  fd.append("hole_area_px", hole_area_px);
  fd.append("thr_offset", thr_offset);
  if(nm_per_px) fd.append("nm_per_px", nm_per_px);

  try{
    const res = await fetch("/api/sem/analyze", { method:"POST", body: fd });
    const j = await res.json();

    if(!j.ok){
      setStatus("Error: " + (j.error || "unknown"));
      document.getElementById("jsonDetails").style.display = "block";
      document.getElementById("out").textContent = JSON.stringify(j, null, 2);
      return;
    }

    document.getElementById("fileCard").style.display = "block";
    document.getElementById("resizeFactor").textContent = fmt(j.resize_factor_used);
    document.getElementById("effScale").textContent = j.nm_per_px_effective ? (fmt(j.nm_per_px_effective) + " nm/px") : "-";

    if(j.threshold_used !== undefined && j.threshold_used !== null){
      document.getElementById("thrUsed").textContent =
        `${fmt(j.threshold_used)}  (Otsu ${fmt(j.threshold_otsu)} + ${j.threshold_offset})`;
    }else{
      document.getElementById("thrUsed").textContent = "-";
    }

    if(j.preview_overlay_png_b64){
      document.getElementById("overlayBox").style.display = "block";
      document.getElementById("overlayImg").src = "data:image/png;base64," + j.preview_overlay_png_b64;
    }
    if(j.preview_mask_png_b64){
      document.getElementById("maskBox").style.display = "block";
      document.getElementById("maskImg").src = "data:image/png;base64," + j.preview_mask_png_b64;
    }

    document.getElementById("metricsCards").style.display = "grid";
    document.getElementById("mFg").textContent = fmt(j.area_fraction_foreground);
    document.getElementById("mBg").textContent = fmt(j.area_fraction_background);

    document.getElementById("mN").textContent = (j.stats_px && j.stats_px.n !== undefined) ? j.stats_px.n : "-";
    document.getElementById("mMeanPx").textContent = fmt(j.stats_px ? j.stats_px.mean : null);
    document.getElementById("mMedPx").textContent = fmt(j.stats_px ? j.stats_px.median : null);
    document.getElementById("mMeanUm").textContent = (j.stats_um && j.stats_um.mean !== undefined) ? fmt(j.stats_um.mean) : "-";

    // data-only JSON (strip base64)
    const compact = {...j};
    if(compact.preview_overlay_png_b64) delete compact.preview_overlay_png_b64;
    if(compact.preview_mask_png_b64) delete compact.preview_mask_png_b64;

    document.getElementById("jsonDetails").style.display = "block";
    document.getElementById("out").textContent = JSON.stringify(compact, null, 2);

    setStatus("Fertig.");
    document.getElementById("metricsCards").scrollIntoView({behavior:"smooth", block:"start"});
  }catch(e){
    setStatus("Error: " + e);
  }
}
</script>
</body>
</html>
